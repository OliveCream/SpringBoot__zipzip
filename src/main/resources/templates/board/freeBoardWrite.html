<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
<div th:replace="/common/header :: header"></div>
<link rel="stylesheet" href="/resources/css/freeBoardWrite.css" />
</head>

<body>
    <!-- ë„¤ë¹„ ì‹œì‘ -->
    <div th:replace="/common/nav :: nav"></div>
    <!-- ë„¤ë¹„ ë -->

    <!-- ë³¸ë¬¸ ì‹œì‘ -->
    <div layout:fragment="content">
        <div style="height: 13vh;"></div>

        <div class="board-Page-container">
            <div class="board-container">
                <!-- ê²Œì‹œíŒ ì „ì²´ ë‚´ìš© div -->
                <div class="board-content-container" th:if="${user != null}">
                   <div class="title-container">ğŸ’› ììœ ê²Œì‹œíŒ ê¸€ì“°ê¸° ğŸ’›</div>
                   <div class="label-container">
                       <label class="label-write" for="title">ì‘ì„±ì ğŸ˜Š</label>
                       <input type="text" id="boardWriter" name="boardWriter" th:value="${user.userId}" readonly>
                       <label class="label-write" for="title">ì œëª© ğŸ„</label>
                       <input type="text" id="boardTitle" name="boardTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.">
                       <label class="label-write" for="content">ë‚´ìš© ğŸŒ´</label>
                    </div>
<div class="textarea-css1">
   <div class="textarea-css2">
                       <div id="editorContent" name="editorContent" ></div>
               <script src="/resources/js/ckeditor/build/ckeditor.js"></script>
               <script>
                  var myEditor;
                  
                  class MyUploadAdapter {
                      constructor(loader) {
                          this.loader = loader;
                      }
                  
                      upload() {
                          return this.loader.file
                              .then(file => new Promise((resolve, reject) => {
                                  this._initRequest();
                                  this._initListeners(resolve, reject, file);
                                  this._sendRequest(file);
                              }));
                      }
                  
                      abort() {
                          if (this.xhr) {
                              this.xhr.abort();
                          }
                      }
                  
                      _initRequest() {
                          const xhr = this.xhr = new XMLHttpRequest();
                  
                          xhr.open('POST', '/upload', true);
                          xhr.responseType = 'json';
                      }
                  
                      _initListeners(resolve, reject, file) {
                          const xhr = this.xhr;
                          const loader = this.loader;
                          const genericErrorText = `${file.name} íŒŒì¼ì„ ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
                  
                          xhr.addEventListener('error', () => reject(genericErrorText));
                          xhr.addEventListener('abort', () => reject());
                          xhr.addEventListener('load', () => {
                              const response = xhr.response;
                  
                              if (!response || response.error) {
                                  return reject(response && response.error ? response.error.message : genericErrorText);
                              }
                  
                              resolve({
                                  default: response.url
                              });
                          });
                  
                          if (xhr.upload) {
                              xhr.upload.addEventListener('progress', evt => {
                                  if (evt.lengthComputable) {
                                      loader.uploadTotal = evt.total;
                                      loader.uploaded = evt.loaded;
                                  }
                              });
                          }
                      }
                  
                      _sendRequest(file) {
                          const data = new FormData();
                  
                          data.append('upload', file);
                  
                          this.xhr.send(data);
                      }
                  }
                  
                  function MyCustomUploadAdapterPlugin(editor) {
                      editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
                          return new MyUploadAdapter(loader);
                      };
                  }
   
                  // í™”ë©´ ì—°ê²°
                  ClassicEditor
                     .create( document.querySelector( '#editorContent' ), {
                          extraPlugins: [ MyCustomUploadAdapterPlugin ],
                      })
                           .then( editor => {
                              myEditor = editor;
                               console.log( 'Editor was initialized', editor );
                           } )
                           .catch( error => {
                               console.error( 'There was a problem initializing the editor -- ', error );
                           } );
   
   
               </script>
   </div>
</div>
                    <div class="button-container">
                       <button id="back">ëŒì•„ê°€ê¸° ğŸ‘ˆ</button>
                        <button id="btnWrite">ê²Œì‹œí•˜ê¸° ğŸ“ƒ</button>
                    </div>
                </div>
                <!-- ê²Œì‹œíŒ ì „ì²´ ë‚´ìš© div ë -->
            </div>
        </div>
</div>

        <!-- ë³¸ë¬¸ ë -->

        <!-- í‘¸í„° ì‹œì‘ -->
        <footer th:replace="/common/footer :: footer"></footer>
        <!-- í‘¸í„° ë -->

        <!-- ê°œë³„ js -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script type="text/javascript">

        $(document).ready(function() {
           
          if('[[${user}]]' == 'null' || '[[${user}]]' == ''){
             alert("ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ íšŒì› ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ");
             location.href = "/board/freeBoard";
          }
           
           $("#btnWrite").on("click", function(){
              
              if('[[${user}]]' == 'null' || '[[${user}]]' == ''){
                 alert("ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ íšŒì› ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ");
                 location.href = "/board/freeBoard";
              }
              
//               alert("dd");
              $("#btnWrite").prop("disabled", true);
              
              var boardTitle = $("#boardTitle").val();
              var editorData = myEditor.getData();
              
              if($.trim(boardTitle).length <= 0){
                 alert("ê²Œì‹œê¸€ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                 $("#boardTitle").val("");
                 $("#boardTitle").focus();
                 
                 $("#btnWrite").prop("disabled", false);
                 return;
              }
              
              if($.trim(boardTitle).length > 33){
                 alert("ê²Œì‹œê¸€ ì œëª©ì€ ê³µë°±í¬í•¨ 30ì ê¹Œì§€ë§Œ ì…ë ¥í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                 $("#boardTitle").focus();
                 
                 $("#btnWrite").prop("disabled", false);
                 return;
              }
              
              if($.trim(editorData).length <= 0){
                 alert("ê²Œì‹œê¸€ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.")
                 myEditor.focus();
                 $("#btnWrite").prop("disabled", false);
                 return;
              }
              

              
              $.ajax({
                 type:"POST",
                 url:"/board/writeProc",
                 data:{
                    boardWriter:$("#boardWriter").val(),
                    boardTitle:$("#boardTitle").val(),
                    boardContent:editorData
                 },
                 datatype:"JSON",
                 cache:false,
                 beforeSend:function(xhr){
                    xhr.setRequestHeader("AJAX", "true");
                 },
                 success:function(res){
                    if(res == 200){
                       alert("ê²Œì‹œê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                       location.href = "/board/freeBoard";   
                    }
                    else if(res == 400){
                       alert("ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                       $("#boardTitle").focus();
                       $("#btnWrite").prop("disabled", false);
                    }
                    else{
                       alert("ê²Œì‹œê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
                       $("#boardTitle").focus();
                       $("#btnWrite").prop("disabled", false);
                    }
                 },
                 error:function(error){
                    alert("ê²Œì‹œê¸€ ë“±ë¡ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
                    $("#btnWrite").prop("disabled", false);
                 }
              });      
           });
           
           //ëŒì•„ê°€ê¸°
           $("#back").on("click", function(){
              if(confirm("ì‘ì„± ì·¨ì†Œì‹œ ì‘ì„±í•˜ì‹  ê¸€ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. \nì •ë§ë¡œ ê¸€ì‘ì„±ì„ ì·¨ì†Œí•˜ê³  ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ? ")){
                 location.href = "/board/freeBoard";
              }
           });
           
           
        });

        </script>
</body>

</html>